


<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Growstation – Controllo LED (solo MQTT)</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; }
    .card { max-width: 560px; border: 1px solid #e5e7eb; border-radius: 14px; padding: 18px; box-shadow: 0 2px 10px rgba(0,0,0,.04); }
    .row { display: flex; gap: 12px; align-items: center; justify-content: space-between; }
    .muted { color: #6b7280; font-size: 14px; }
    .big { font-size: 32px; font-weight: 700; }
    .ok { color: #10b981; }
    .err { color: #ef4444; }
    input[type="range"] { width: 100%; }
    code { background: #f3f4f6; padding: 0 6px; border-radius: 6px; }
    .btn { padding: 6px 12px; border-radius: 8px; border: 1px solid #e5e7eb; cursor: pointer; }
    .btn-on  { background:#ecfdf5; color:#065f46; }
    .btn-off { background:#fef2f2; color:#7f1d1d; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .device-on  { outline: 2px solid #10b981; }
    .device-off { outline: 2px solid #ef4444; }

  </style>
</head>
<body>
  <div class="card">
    <h2>Growstation – Frontend solo MQTT</h2>
    <div id="conn" class="muted">Stato connessione: <span id="conn_state" class="err">disconnesso</span></div>

    <hr />

    <h3>Controllo LED (PWM)</h3>
    <div class="row">
      <label for="led1Range">LED1 PWM</label>
      <input id="led1Range" type="range" min="0" max="1023" step="1" value="0" />
      <output id="led1Val">0</output>
    </div>
    <p class="muted">Pubblica su topic <code>growstation/control/led1</code> il valore 0–1023.</p>
    <hr />
    <div class="row">
      <label for="led2Range">LED2 PWM</label>
      <input id="led2Range" type="range" min="0" max="1023" step="1" value="0" />
      <output id="led2Val">0</output>
    </div>
    <p class="muted">Pubblica su topic <code>growstation/control/led2</code> il valore 0–1023.</p>
    <hr />
    <div class="row">
      <label for="led3Range">LED3 PWM</label>
      <input id="led3Range" type="range" min="0" max="1023" step="1" value="0" />
      <output id="led3Val">0</output>
    </div>
    <p class="muted">Pubblica su topic <code>growstation/control/led3</code> il valore 0–1023.</p>
    <hr />
    <div class="card">

    <h3>Dati Sensore (DHT22)</h3>
    <div class="row"><div>Temperatura</div><div class="big" id="temp">--.- °C</div></div>
    <div class="row"><div>Umidità</div><div class="big" id="hum">--.- %</div></div>
    <p class="muted">Riceve JSON da <code>growstation/sensor/dht22</code> </p>
  </div>
    <hr />
    <div>
    <h3>OROLOGIO</h3>
    <div class="row"><div>Data</div><div class="big" id="data"> --/--/--</div></div>
    <div class="row"><div>Ora</div><div class="big" id="ora"> --:--:--</div></div>
    <p class="muted">Riceve da <code>growstation/clock</code> </p>
    </div>
        </div>

    <hr />
<h3>Dispositivi</h3>

<div class="row">
  <div>
    <strong>Ventilatore</strong>
    <div class="muted">Topic: <code>growbox/control/ventilador</code></div>
  </div>
  <div>
    <button id="fanOn"  class="btn btn-on">ON</button>
    <button id="fanOff" class="btn btn-off">OFF</button>
  </div>
</div>

<div class="row" style="margin-top:8px">
  <div>
    <strong>Irrigazione</strong>
    <div class="muted">Topic: <code>growbox/control/irrigation</code></div>
  </div>
  <div>
    <button id="irrOn"  class="btn btn-on">ON</button>
    <button id="irrOff" class="btn btn-off">OFF</button>
  </div>
</div>
    <div class="row" style="margin-top:8px">
  <div>
    <strong>Device esterno</strong>
    <div class="muted">Topic: <code>growbox/control/device_ext</code></div>
  </div>
  <div>
    <button id="devOn"  class="btn btn-on">ON</button>
    <button id="devOff" class="btn btn-off">OFF</button>
  </div>
</div>

<script>
  // === CONFIG ===
  const MQTT_URL = 'wss://a74d6462f9e64dd1bcb79f0518a2136e.s1.eu.hivemq.cloud:8884/mqtt';
  const MQTT_OPTIONS = {
    connectTimeout: 5000,
    clientId: 'web_'+Math.random().toString(16).slice(2),
    username: 'growstationRadio',
    password: 'Mqtt2025',
    clean: true,
    // path: '/mqtt', // se necessario su HiveMQ Cloud
  };

  const TOPIC_SENSOR_DHT22 = 'growstation/sensor/dht22';
  const TOPIC_CLOCK        = 'growstation/clock';
  const TOPIC_CONTROL_L1   = 'growstation/control/led1';
  const TOPIC_CONTROL_L2   = 'growstation/control/led2';
  const TOPIC_CONTROL_L3   = 'growstation/control/led3';

  // === TOPIC DISPOSITIVI ===
  const TOPIC_FAN_CTRL     = 'growbox/control/ventilador';
  const TOPIC_IRR_CTRL     = 'growbox/control/irrigation';
  const TOPIC_FAN_STATUS   = 'growbox/status/ventilador';
  const TOPIC_IRR_STATUS   = 'growbox/status/irrigation';
 const TOPIC_DEV_CTRL     = 'growbox/control/device_ext';
  const TOPIC_DEV_STATUS   = 'growbox/status/device_ext';
  // === CONNESSIONE MQTT ===
  const client = mqtt.connect(MQTT_URL, MQTT_OPTIONS);
  const connEl = document.getElementById('conn_state');

  client.on('connect', () => {
    connEl.textContent = 'connesso';
    connEl.classList.remove('err');
    connEl.classList.add('ok');

    client.subscribe(
      [TOPIC_SENSOR_DHT22, TOPIC_CLOCK, TOPIC_FAN_STATUS, TOPIC_IRR_STATUS, TOPIC_DEV_STATUS ],
      { qos: 1 }
    );
  });

  client.on('close', () => {
    connEl.textContent = 'disconnesso';
    connEl.classList.remove('ok');
    connEl.classList.add('err');
  });

  client.on('error', (e) => console.error('MQTT error', e));

  // === ELEMENTI UI ===
  const tempEl = document.getElementById('temp');
  const humEl  = document.getElementById('hum');
  const dataEl = document.getElementById('data');
  const oraEl  = document.getElementById('ora');

  const fanOn  = document.getElementById('fanOn');
  const fanOff = document.getElementById('fanOff');
  const irrOn  = document.getElementById('irrOn');
  const irrOff = document.getElementById('irrOff');
  const devON = document.getElementById('devOn');
    const devOff = document.getElementById('devOff');
  // === RICEZIONE MESSAGGI ===
  client.on('message', (topic, payload) => {
    let msg;
    try { msg = JSON.parse(payload.toString()); }
    catch (err) {
      console.warn('Payload non valido:', payload?.toString());
      return;
    }

    if (topic === TOPIC_SENSOR_DHT22) {
      if (typeof msg.temp === 'number') tempEl.textContent = msg.temp.toFixed(1) + ' °C';
      if (typeof msg.hum  === 'number') humEl.textContent  = msg.hum.toFixed(1)  + ' %';
    } else if (topic === TOPIC_CLOCK) {
      if (typeof msg.data === 'string') dataEl.textContent = msg.data;
      if (typeof msg.ora  === 'string') oraEl.textContent  = msg.ora;
    } else if (topic === TOPIC_FAN_STATUS) {
      if (msg && typeof msg.state === 'string') {
        const on = msg.state.toUpperCase() === 'ON';
        fanOn .classList.toggle('device-on',  on);
        fanOff.classList.toggle('device-off', !on);
      }
    } else if (topic === TOPIC_IRR_STATUS) {
      if (msg && typeof msg.state === 'string') {
        const on = msg.state.toUpperCase() === 'ON';
        irrOn .classList.toggle('device-on',  on);
        irrOff.classList.toggle('device-off', !on);
      }} else if (topic === TOPIC_DEV_STATUS) {
      if (msg && typeof msg.state === 'string') {
        const on = msg.state.toUpperCase() === 'ON';
        irrOn .classList.toggle('device-on',  on);
        irrOff.classList.toggle('device-off', !on);
    }
  });

  // === CONTROLLO LED ===
  const led1Range = document.getElementById('led1Range');
  const led1Out   = document.getElementById('led1Val');
  const led2Range = document.getElementById('led2Range');
  const led2Out   = document.getElementById('led2Val');
  const led3Range = document.getElementById('led3Range');
  const led3Out   = document.getElementById('led3Val');

  const DEBOUNCE_MS = 120;
  let t1, t2, t3;

  led1Range.addEventListener('input', e => {
    const v = parseInt(e.target.value, 10) || 0;
    led1Out.textContent = v;
    clearTimeout(t1);
    t1 = setTimeout(() => {
      if (client.connected) client.publish(TOPIC_CONTROL_L1, String(v), { qos: 1, retain: false });
    }, DEBOUNCE_MS);
  });

  led2Range.addEventListener('input', e => {
    const v = parseInt(e.target.value, 10) || 0;
    led2Out.textContent = v;
    clearTimeout(t2);
    t2 = setTimeout(() => {
      if (client.connected) client.publish(TOPIC_CONTROL_L2, String(v), { qos: 1, retain: false });
    }, DEBOUNCE_MS);
  });

  led3Range.addEventListener('input', e => {
    const v = parseInt(e.target.value, 10) || 0;
    led3Out.textContent = v;
    clearTimeout(t3);
    t3 = setTimeout(() => {
      if (client.connected) client.publish(TOPIC_CONTROL_L3, String(v), { qos: 1, retain: false });
    }, DEBOUNCE_MS);
  });

  // === COMANDI DISPOSITIVI (JSON) ===
  function publishCmd(topic, state) {
    if (!client.connected) return console.warn('MQTT non connesso');
    const payload = JSON.stringify({ state: String(state).toUpperCase() }); // "ON"/"OFF"
    client.publish(topic, payload, { qos: 1, retain: false });
  }

  fanOn .addEventListener('click', () => publishCmd(TOPIC_FAN_CTRL, 'ON'));
  fanOff.addEventListener('click', () => publishCmd(TOPIC_FAN_CTRL, 'OFF'));
  irrOn .addEventListener('click', () => publishCmd(TOPIC_IRR_CTRL, 'ON'));
  irrOff.addEventListener('click', () => publishCmd(TOPIC_IRR_CTRL, 'OFF'));
  devOn .addEventListener('click', () => publishCmd(TOPIC_DEV_CTRL, 'ON'));
  devOff.addEventListener('click', () => publishCmd(TOPIC_DEV_CTRL, 'OFF'));
</script>
</body>
</html>
