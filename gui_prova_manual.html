<!-- mqtt.js (se non lo hai già incluso altrove) -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<div class="card" style="max-width:680px;padding:16px;border:1px solid #e5e7eb;border-radius:14px">
  <h3>Modalità Manuale – Programmazione</h3>
   <!-- aggiungi uno stato connessione dove preferisci -->
<div style="margin:8px 0">
  Stato MQTT: <span id="conn_state" class="err">disconnesso</span>
</div>

  <label>Fase</label>
  <div id="phaseBtns" style="display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 12px">
    <button class="phase" data-key="plantula">Plantula [18h]</button>
    <button class="phase" data-key="veg">Vegetativa [18h]</button>
    <button class="phase" data-key="flora">Flora [12h]</button>
    <button class="phase" data-key="uv">UV [12h]</button>
  </div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
    <div>
      <label>Settimane ciclo</label>
      <input id="weeks" type="number" min="1" step="1" placeholder="es. 6">
    </div>
    <div>
      <label>Data inizio (opz.)</label>
      <input id="startDate" type="date">
    </div>
    <div>
      <label>Ora accensione luci</label>
      <input id="lightOn" type="time" required>
      <div id="offHint" style="color:#6b7280;font-size:0.9em;margin-top:4px">Spegnimento: [—]</div>
    </div>
    <div>
      <label>Ora irrigazione</label>
      <input id="irrigTime" type="time" required>
      <label style="display:block;margin-top:6px">Durata irrigazione (min)</label>
      <input id="irrigMin" type="number" min="1" step="1" placeholder="es. 2">
    </div>
  </div>

  <div id="summary" style="margin-top:12px;color:#6b7280">—</div>

  <div style="margin-top:14px;display:flex;gap:8px">
    <button id="preview">Anteprima payload</button>
    <button id="send">Invia a MQTT</button>
  </div>

  <pre id="payload" style="margin-top:12px;background:#f8fafc;padding:12px;border-radius:10px;overflow:auto;max-height:280px"></pre>
</div>

<script>
  // Mappa fasi → fotoperiodo (per calcolare lo spegnimento; NON viene inviato)
  const PHASES = {
    plantula: { label: "Plantula", photoperiod_h: 18 },
    veg:      { label: "Vegetativa", photoperiod_h: 18 },
    flora:    { label: "Flora",      photoperiod_h: 12 },
    uv:       { label: "UV",         photoperiod_h: 12 },
  };

  // ---- UI logic ----

  
  const DAYS = ["mon","tue","wed","thu","fri","sat","sun"]; // non usati nel payload manuale
  let selectedKey = null;
  const $phaseBtns = [...document.querySelectorAll(".phase")];

  $phaseBtns.forEach(b => b.onclick = () => {
    selectedKey = b.dataset.key;
    $phaseBtns.forEach(x => x.style.outline = "");
    b.style.outline = "2px solid #2563eb";
    updateDerived();
  });

  ["weeks","startDate","lightOn","irrigTime","irrigMin"].forEach(id =>
    document.getElementById(id).addEventListener("input", updateDerived)
  );

  function pad2(n){ return n < 10 ? "0"+n : ""+n; }

  function todayISO() {
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }

  function addWeeksISO(isoDate, weeks) {
    const d = isoDate ? new Date(isoDate+"T00:00:00") : new Date();
    d.setDate(d.getDate() + weeks*7);
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }

  // hh:mm + hours → "HH:MM" (mod 24h)
  function addHoursToTime(hhmm, hours) {
    if (!hhmm) return "";
    const [H,M] = hhmm.split(":").map(Number);
    const totalMin = H*60 + M + Math.round(hours*60);
    const mod = ((totalMin % (24*60)) + (24*60)) % (24*60);
    return `${pad2(Math.floor(mod/60))}:${pad2(mod%60)}`;
  }

  function updateDerived() {
    const phase = selectedKey ? PHASES[selectedKey] : null;
    const weeks = Number(document.getElementById("weeks").value || 0);
    const startDate = document.getElementById("startDate").value || todayISO();
    const lightOn = document.getElementById("lightOn").value || "";
    const irrigTime = document.getElementById("irrigTime").value || "";
    const irrigMin = Number(document.getElementById("irrigMin").value || 0);

    const off = (phase && lightOn) ? addHoursToTime(lightOn, phase.photoperiod_h) : "—";
    document.getElementById("offHint").textContent = `Spegnimento: [${off}]`;

    const until = (weeks>0) ? addWeeksISO(startDate, weeks) : "—";
    const phaseLbl = phase ? phase.label : "—";
    document.getElementById("summary").textContent =
      `Fase: ${phaseLbl} • Settimane: ${weeks||"—"} • Inizio: ${startDate} • Fine: ${until} • Luci: ${lightOn||"—"} → [${off}] • Irrig: ${irrigTime||"—"} × ${irrigMin||"—"} min`;
  }

  function buildPayload() {
    if (!selectedKey) throw new Error("Seleziona una fase.");
    const weeks = Number(document.getElementById("weeks").value);
    if (!weeks || weeks < 1) throw new Error("Inserisci le settimane (>0).");

    const startDate = document.getElementById("startDate").value || todayISO();
    const lightOn   = document.getElementById("lightOn").value;
    const irrigTime = document.getElementById("irrigTime").value;
    const irrigMin  = Number(document.getElementById("irrigMin").value);

    if (!lightOn)   throw new Error("Imposta l'ora di accensione luci.");
    if (!irrigTime) throw new Error("Imposta l'ora di irrigazione.");
    if (!irrigMin)  throw new Error("Imposta la durata irrigazione (min).");

    // Payload atteso dal firmware (nessun light_off, nessun until_date)
    return {
      phase: selectedKey,           // "plantula" | "veg" | "flora" | "uv"
      weeks: weeks,
      start_date: startDate,        // "YYYY-MM-DD"
      light_on: lightOn,            // "HH:MM"
      irrig_time: irrigTime,        // "HH:MM"
      irrig_minutes: irrigMin       // intero
    };
  }

  document.getElementById("preview").onclick = () => {
    try {
      const payload = buildPayload();
      document.getElementById("payload").textContent = JSON.stringify(payload, null, 2);
    } catch (e) { alert(e.message); }
  };

  // ---- MQTT publish ----
  const TOPIC_SET   = "growstation/config/manual/set";
  const TOPIC_STATE = "growstation/config/manual/state"; // opzionale: per vedere l'ack
  const TOPIC_EVT   = "growstation/events/schedule"

 // === CONFIG MQTT===
    const MQTT_URL = 'wss://a74d6462f9e64dd1bcb79f0518a2136e.s1.eu.hivemq.cloud:8884/mqtt';
    const MQTT_OPTIONS = {
      connectTimeout: 5000,
      clientId: 'web_'+Math.random().toString(16).slice(2),
      username: 'growstationRadio',
      password: 'Mqtt2025',
      clean: true,
    };

    // === CONNESSIONE MQTT ===
    const client = mqtt.connect(MQTT_URL, MQTT_OPTIONS);
    const connEl = document.getElementById('conn_state');
    client.on('connect', () => {
      connEl.textContent = 'conectado';
      connEl.classList.remove('err');
      connEl.classList.add('ok');

      client.subscribe([TOPIC_STATE, TOPIC_EVT], { qos: 1 });
    });

    client.on('close', () => {
      connEl.textContent = 'desconectado';
      connEl.classList.remove('ok');
      connEl.classList.add('err');
    });

    client.on('error', (e) => console.error('MQTT error', e));


const sendBtn = document.getElementById("send");
sendBtn.disabled = true;

client.on('connect', () => {
  connEl.textContent = 'connesso';
  connEl.classList.remove('err');
  connEl.classList.add('ok');

  client.subscribe([TOPIC_STATE, TOPIC_EVT], { qos: 1 });
  sendBtn.disabled = false;
});

client.on('close', () => {
  connEl.textContent = 'disconnesso';
  connEl.classList.remove('ok');
  connEl.classList.add('err');
  sendBtn.disabled = true;
});
  
  document.getElementById("send").onclick = () => {
  try {
    const payload = buildPayload();
    document.getElementById("payload").textContent = JSON.stringify(payload, null, 2);

    if (!client.connected) { alert("MQTT non connesso."); return; }

    client.publish(TOPIC_SET, JSON.stringify(payload), { qos: 1, retain: true });
    alert("Inviato a MQTT (retain). Attendi l'ack su /state.");
  } catch (e) {
    alert(e.message);
  }
};
</script>
